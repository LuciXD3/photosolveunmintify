(()=>{"use strict";var e=function(e,t,s,a){return new(s||(s=Promise))((function(o,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function i(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,i)}c((a=a.apply(e,t||[])).next())}))};let t=null,s=!1,a=null;function o(e,t=100){chrome.tabs.query({active:!0,currentWindow:!0},(function(s){s&&s.length>0&&""!==s[0].url&&"complete"===s[0].status?e(s[0].id):setTimeout((()=>{o(e,t)}),t)}))}var n=function(e,t,s,a){return new(s||(s=Promise))((function(o,n){function r(e){try{c(a.next(e))}catch(e){n(e)}}function i(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,i)}c((a=a.apply(e,t||[])).next())}))};try{let r=null,i=null;chrome.runtime.onInstalled.addListener((()=>{chrome.storage.sync.get(["isPro","limit"],(e=>{void 0===e.limit&&chrome.storage.sync.set({limit:0}),void 0===e.isPro&&chrome.storage.sync.set({isPro:!1})}))})),chrome.runtime.onMessage.addListener(((e,t,s)=>("generate_token"===e.message&&function(){return n(this,void 0,void 0,(function*(){const e=new TextEncoder,t=String((new Date).getTime()),s=yield crypto.subtle.importKey("raw",e.encode("u287L0EKjczkjmzSIgTZp9LP7WHJCmJE"),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),a=yield crypto.subtle.sign("HMAC",s,e.encode(t));return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")+"."+t}))}().then((e=>{s({message:"token_generated",payload:e})})),!0))),chrome.runtime.onMessage.addListener(((e,t,s)=>{if("aitutor"===e.message)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&chrome.tabs.sendMessage(e[0].id,"aitutor")})),s(!0);else if("askAITutor"===e.message&&e.question)chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t.length>0&&chrome.tabs.sendMessage(t[0].id,{message:"askAITutor",question:e.question})})),s(!0);else if("updateStealthShortcut"===e.message){const t=e.shortcut;chrome.storage.sync.set({stealthShortcut:t},(()=>{}))}else if("check_tab_status"===e.message)return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{var a;e.length>0&&(null===(a=t.tab)||void 0===a?void 0:a.id)===e[0].id?s({status:"active"}):s({status:"inactive"})})),!0;"cancel_popup"===e.message?(r&&(r.abort(),r=null),s({status:"cancelled"})):"scan"===e.message&&(r&&r.abort(),r=new AbortController,i=r.signal,chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&chrome.tabs.sendMessage(e[0].id,"scan")})),s(!0))})),chrome.runtime.onMessage.addListener(((e,t,s)=>{if("get_answer"===e.message.command)return chrome.storage.sync.get(["limit","isPro","license_key"],(t=>{t.isPro||t.limit<10?fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign({history:e.message.payload},t.isPro&&{licenseKey:t.license_key}))}).then((e=>e.text())).then((e=>{t.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,10);chrome.storage.sync.set({limit:t})})),e.endsWith("None")?s({status:"success",data:e.slice(0,-4)}):s({status:"success",data:e})})).catch((e=>{s({status:"error",data:`An error occurred: ${e}`})})):s({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})})),!0;if("ssAITutor"===e.message)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.scripting.executeScript({target:{tabId:e[0].id},files:["./helper/ssaitutor.js"]})}));else{if("capture_ss"===e.message)return chrome.runtime.lastError?void s({message:"fail"}):(setTimeout((()=>{chrome.tabs.captureVisibleTab(null,null,(function(e){s({message:"captured_successfully",payload:e})}))}),500),!0);"ss_dataUrl_sent"===e.message&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,{message:"image_sent",payload:e.payload})}))}})),chrome.runtime.onConnect.addListener((e=>{e.onMessage.addListener((t=>{"get_answer"===t.message.command?chrome.storage.sync.get(["limit","isPro"],(s=>{s.isPro||s.limit<10?fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then((t=>{const a=t.body.getReader(),o=()=>{a.read().then((({done:t,value:a})=>{if(t)return s.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,10);chrome.storage.sync.set({limit:t},(()=>{}))})),void e.postMessage({status:"done"});let n=new TextDecoder("utf-8").decode(a);return e.postMessage({status:"streaming",data:n}),o()}))};o()})).catch((t=>{e.postMessage({status:"error",data:`An error occurred: ${t}`})})):e.postMessage({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})})):"aiTutorImage"===t.message.command&&chrome.storage.sync.get(["limit","isPro"],(s=>{if(s.isPro||s.limit<10){const a=new FormData,o=function(e){const t=atob(e.split(",")[1]),s=[];for(let e=0;e<t.length;e++)s.push(t.charCodeAt(e));const a=new Blob([new Uint8Array(s)],{type:e.type});return new File([a],e.name,{type:e.type})}(t.payload.image);a.append("image",o,"image.png"),a.append("licenseKey",t.payload.licenseKey),a.append("isGpt4",t.payload.isGpt4),a.append("history",t.payload.history),fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_with_image_v2",{method:"POST",body:a}).then((t=>{const a=t.body.getReader(),o=()=>{a.read().then((({done:t,value:s})=>{if(t)return void e.postMessage({status:"done"});let a=new TextDecoder("utf-8").decode(s);return e.postMessage({status:"streaming",data:a}),o()}))};o(),s.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,10);chrome.storage.sync.set({limit:t})}))})).catch((t=>{e.postMessage({status:"error",data:`An error occurred: ${t}`})}))}else e.postMessage({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})}))}))})),function(n,r){chrome.runtime.onMessage.addListener(((n,i,c)=>{if("scan"===n.message)o((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content.js"]})}));else{if("capture"===n.message)return chrome.runtime.lastError?void c({message:"fail"}):(chrome.tabs.captureVisibleTab(null,null,(function(e){c({message:"captured_successfully",payload:e})})),!0);if("cropped_dataUrl_sent"===n.message){a&&a.abort(),a=new AbortController,r=a.signal;const i=new FormData,c=function(e){const t=e.split(","),s=t[0].match(/:(.*?);/)[1],a=atob(t[1]);let o=a.length,n=new Uint8Array(o);for(;o--;)n[o]=a.charCodeAt(o);return new Blob([n],{type:s})}(n.payload);i.append("image",c,"image.png"),chrome.storage.sync.get(["isPro","license_key","deviceId","stealthMode","limit"],(a=>{const n=!a.isPro&&a.limit>=10,c=a.stealthMode||!1;if(a.isPro&&(i.append("license_key",a.license_key),i.append("deviceId",a.deviceId)),n)o((e=>{chrome.tabs.sendMessage(e,{answer:"Limit Reached",question:"You have reached the maximum number of scans. Please upgrade to pro version to continue using Photosolve",subject:"Limit Reached",command:"image_processed"})}));else{let a="process_image";chrome.storage.sync.get(["imageVision","powerfulAI","isPro"],(n=>{n.isPro?n.imageVision&&n.powerfulAI||n.imageVision?a="process_image_vision":n.powerfulAI&&(a="process_image_pro"):n.imageVision&&(a="process_image_vision"),o(c?e=>{chrome.tabs.sendMessage(e,{command:"show_stealth_loading"})}:e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/wait.js"]},(()=>{chrome.scripting.insertCSS({target:{tabId:e},files:["./helper/wait.css"]})}))}),fetch(`https://coral-app-opv8j.ondigitalocean.app/${a}`,{method:"POST",body:i,signal:r}).then((n=>{if("process_image_vision"!==a)return n.json().then((e=>(o((t=>{chrome.tabs.sendMessage(t,Object.assign(Object.assign({},e),{command:c?"image_processed_stealth":"image_processed"}))})),e)));{const a=n.body.getReader();let r="",i=!1,m={};const d=()=>e(this,void 0,void 0,(function*(){try{const{done:e,value:n}=yield a.read();if(e)return t=m,s=!0,void o((e=>{chrome.tabs.sendMessage(e,Object.assign(Object.assign({},t),{command:c?"image_processed_stealth":"image_processed_final"}))}));r+=new TextDecoder("utf-8").decode(n);let l=r.split("\n").filter((e=>""!==e.trim()));for(let e of l)try{const t=JSON.parse(e);c||(i||(o((e=>{chrome.tabs.sendMessage(e,{question:"",answer:"",subject:"",command:"image_processed_partial"})})),i=!0),o((e=>{chrome.tabs.sendMessage(e,Object.assign(Object.assign({},t),{command:"image_processed_partial"}))}))),m=t;const s=r.indexOf(e)+e.length;r=r.slice(s)}catch(e){}yield d()}catch(e){console.error("Error in readChunk:",e)}}));d()}})).then((e=>{if("process_image_vision"!==a){function t(){o((s=>{chrome.tabs.sendMessage(s,Object.assign(Object.assign({},e),{command:c?"image_processed_stealth":"image_processed"}),(e=>{chrome.runtime.lastError?setTimeout(t,50):c||chrome.tabs.sendMessage(s,{command:"remove_loading"})}))}))}t(),o((t=>{chrome.tabs.sendMessage(t,{message:"check_tab_status"},(t=>{t&&"inactive"===t.status&&chrome.storage.local.set({lastResponse:{question:e.question,answer:e.answer,subject:e.subject,isStealthMode:c}})}))}))}chrome.storage.sync.get(["limit","isPro"],(e=>{!e.isPro&&e.limit<10&&chrome.storage.sync.set({limit:e.limit+1})}))})).catch((e=>(c&&o((e=>{chrome.tabs.sendMessage(e,{command:"hide_stealth_loading"})})),{status:"error",data:`An error occurred: ${e}`})))}))}}))}else if("cancel_popup"===n.message)a&&(a.abort(),a=null),o((e=>{chrome.tabs.sendMessage(e,{command:"remove_loading"})})),c({status:"cancelled"});else{if("editQuestion"===n.message)return chrome.storage.sync.get(["limit","isPro"],(e=>{fetch("https://coral-app-opv8j.ondigitalocean.app/process_text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n.text})}).then((e=>e.json())).then((t=>{c(t),!e.isPro&&e.limit<10&&chrome.storage.sync.set({limit:e.limit+1})}))})),!0;if("close_scan_question"===n.message)o((e=>{chrome.tabs.sendMessage(e,{command:"close_scan_question"})}));else if("activateStealthMode"===n.message)o((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content2.js"]},(()=>{}))}));else if("check_tab_status"===n.message)return o((e=>{c({status:"active"})})),!0}}})),chrome.storage.sync.get(["stealthShortcut"],(e=>{if(!e.stealthShortcut){const e=navigator.platform.toUpperCase().includes("MAC")?"Command+Shift+2":"Ctrl+Shift+Q";chrome.storage.sync.set({stealthShortcut:e})}})),chrome.storage.sync.get(["stealthMode","limit","isPro","stealthShortcut"],(e=>{if(!0===e.stealthMode&&(e.limit<10||e.isPro)){const t=(e.stealthShortcut||"Ctrl+Shift+Q").split("+");document.addEventListener("keydown",(e=>{const s=[];e.ctrlKey&&s.push("Ctrl"),e.shiftKey&&s.push("Shift"),e.altKey&&s.push("Alt"),e.metaKey&&s.push("Command"),s.push(e.key.toUpperCase()),t.length===s.length&&t.every((e=>s.includes(e)))&&o((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content2.js"]},(()=>{}))}))}))}})),document.addEventListener("visibilitychange",(function(){!document.hidden&&t&&o((e=>{chrome.tabs.sendMessage(e,Object.assign(Object.assign({},t),{command:t.isStealthMode?"image_processed_stealth":"image_processed"}))}))}))}(0,i)}catch(e){}})();